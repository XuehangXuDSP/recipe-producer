<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Download Button</title>
    <link rel="stylesheet" href="style.css">
    <!-- JSZip Library for client-side ZIP generation -->
    <script src="libs/jszip.min.js"></script>
    <script>
        // Ensure JSZip is loaded before continuing
        window.JSZipReady = new Promise((resolve) => {
            if (typeof JSZip !== 'undefined') {
                resolve();
            } else {
                const checkJSZip = setInterval(() => {
                    if (typeof JSZip !== 'undefined') {
                        clearInterval(checkJSZip);
                        resolve();
                    }
                }, 10);
            }
        });
    </script>
    <style>
        .diagnostic-panel {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .status-item {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        .fix-button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .fix-primary { background: #007bff; color: white; }
        .fix-success { background: #28a745; color: white; }
        .fix-warning { background: #ffc107; color: black; }
        .fix-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DownloadæŒ‰é’®ä¿®å¤å·¥å…·</h1>
        
        <div class="diagnostic-panel">
            <h3>ğŸ” å½“å‰çŠ¶æ€è¯Šæ–­</h3>
            <div id="status-display"></div>
            <button class="fix-button fix-primary" onclick="runDiagnosis()">é‡æ–°è¯Šæ–­</button>
        </div>
        
        <div class="diagnostic-panel">
            <h3>ğŸ› ï¸ ä¿®å¤æ“ä½œ</h3>
            <button class="fix-button fix-success" onclick="forceEnableButton()">å¼ºåˆ¶å¯ç”¨æŒ‰é’®</button>
            <button class="fix-button fix-warning" onclick="resetButtonState()">é‡ç½®æŒ‰é’®çŠ¶æ€</button>
            <button class="fix-button fix-primary" onclick="recheckJSZip()">é‡æ–°æ£€æŸ¥JSZip</button>
            <button class="fix-button fix-danger" onclick="forceInitialize()">å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–</button>
        </div>
        
        <div class="diagnostic-panel">
            <h3>ğŸ§ª æµ‹è¯•åŒºåŸŸ</h3>
            <p>è¾“å…¥Recipeæ ‡é¢˜æ¥æµ‹è¯•DownloadåŠŸèƒ½ï¼š</p>
            <input type="text" id="test-title" placeholder="æµ‹è¯•Recipeæ ‡é¢˜" style="width: 300px; padding: 8px; margin: 10px 0;">
            <br>
            <button class="fix-button fix-primary" onclick="addTestRecipe()">æ·»åŠ æµ‹è¯•Recipe</button>
            <button class="fix-button fix-success" onclick="testDownloadFunction()">æµ‹è¯•ä¸‹è½½åŠŸèƒ½</button>
        </div>
        
        <!-- åŸå§‹UI -->
        <div class="main-content">
            <div class="content-wrapper">
                <div class="form-section">
                    <div class="recipe-form">
                        <h2>Recipeç¼–è¾‘åŒºåŸŸ</h2>
                        <div class="form-group">
                            <label for="title">Title</label>
                            <input type="text" id="title" name="title">
                        </div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" name="category">
                                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                                <option value="Batch">Batch</option>
                                <option value="Triggers">Triggers</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="right-panel">
                    <div class="actions-section">
                        <div class="actions-header" id="actions-toggle">
                            <h3>Create Recipe</h3>
                            <span class="toggle-icon expanded">â–¼</span>
                        </div>
                        <div class="actions-content" id="actions-content" style="display: block;">
                            <button id="save-current" class="btn-secondary btn-vertical">Save Current Recipe</button>
                            <button id="generate-all" class="btn-primary btn-vertical">Generate & Download All Recipes</button>
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <h3>JSON Preview</h3>
                        <pre id="json-preview">{}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-display');
            const statusClass = type === 'success' ? 'status-success' : 
                               type === 'error' ? 'status-error' : 
                               type === 'warning' ? 'status-warning' : '';
            
            statusDiv.innerHTML += `<div class="status-item ${statusClass}">${message}</div>`;
        }
        
        function clearStatus() {
            document.getElementById('status-display').innerHTML = '';
        }
        
        function runDiagnosis() {
            clearStatus();
            updateStatus('å¼€å§‹è¯Šæ–­æŒ‰é’®çŠ¶æ€...');
            
            // æ£€æŸ¥JSZip
            const jsZipAvailable = typeof JSZip !== 'undefined';
            updateStatus(`JSZipçŠ¶æ€: ${jsZipAvailable ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`, jsZipAvailable ? 'success' : 'error');
            
            // æ£€æŸ¥RecipeProducer
            const rpAvailable = window.recipeProducer !== undefined;
            updateStatus(`RecipeProducerçŠ¶æ€: ${rpAvailable ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}`, rpAvailable ? 'success' : 'error');
            
            if (rpAvailable) {
                updateStatus(`jsZipAvailableæ ‡å¿—: ${window.recipeProducer.jsZipAvailable ? 'âœ… true' : 'âŒ false'}`, 
                            window.recipeProducer.jsZipAvailable ? 'success' : 'error');
            }
            
            // æ£€æŸ¥æŒ‰é’®çŠ¶æ€
            const button = document.getElementById('generate-all');
            if (button) {
                updateStatus(`æŒ‰é’®å­˜åœ¨: âœ… æ˜¯`, 'success');
                updateStatus(`æŒ‰é’®disabled: ${button.disabled ? 'âŒ true' : 'âœ… false'}`, button.disabled ? 'error' : 'success');
                updateStatus(`æŒ‰é’®opacity: ${button.style.opacity || '1'}`, 
                            (button.style.opacity && button.style.opacity !== '1') ? 'warning' : 'success');
                updateStatus(`æŒ‰é’®cursor: ${button.style.cursor || 'default'}`);
                
                // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
                const hasClickListener = button.onclick || button.getAttribute('onclick');
                updateStatus(`ç‚¹å‡»äº‹ä»¶: ${hasClickListener ? 'âœ… å·²ç»‘å®š' : 'âš ï¸ æœªç»‘å®šæˆ–æ— æ³•æ£€æµ‹'}`, 
                            hasClickListener ? 'success' : 'warning');
            } else {
                updateStatus('æŒ‰é’®ä¸å­˜åœ¨: âŒ', 'error');
            }
        }
        
        function forceEnableButton() {
            const button = document.getElementById('generate-all');
            if (button) {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                button.title = 'ç”Ÿæˆå¹¶ä¸‹è½½æ‰€æœ‰Recipeçš„ZIPæ–‡ä»¶';
                
                updateStatus('âœ… æŒ‰é’®å·²å¼ºåˆ¶å¯ç”¨', 'success');
                
                // ç¡®ä¿RecipeProducerçŠ¶æ€ä¹Ÿæ›´æ–°
                if (window.recipeProducer) {
                    window.recipeProducer.jsZipAvailable = true;
                }
            } else {
                updateStatus('âŒ æ‰¾ä¸åˆ°æŒ‰é’®', 'error');
            }
        }
        
        function resetButtonState() {
            if (window.recipeProducer && typeof window.recipeProducer.checkJSZipAvailability === 'function') {
                window.recipeProducer.checkJSZipAvailability();
                updateStatus('âœ… æŒ‰é’®çŠ¶æ€å·²é‡ç½®', 'success');
            } else {
                updateStatus('âŒ æ— æ³•é‡ç½®æŒ‰é’®çŠ¶æ€', 'error');
            }
        }
        
        function recheckJSZip() {
            const jsZipAvailable = typeof JSZip !== 'undefined';
            updateStatus(`JSZipé‡æ–°æ£€æŸ¥ç»“æœ: ${jsZipAvailable ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`, 
                        jsZipAvailable ? 'success' : 'error');
            
            if (jsZipAvailable && window.recipeProducer) {
                window.recipeProducer.jsZipAvailable = true;
                window.recipeProducer.checkJSZipAvailability();
                updateStatus('âœ… RecipeProducer JSZipçŠ¶æ€å·²æ›´æ–°', 'success');
            }
        }
        
        function forceInitialize() {
            if (window.recipeProducer) {
                updateStatus('RecipeProducerå·²å­˜åœ¨ï¼Œé‡æ–°æ£€æŸ¥çŠ¶æ€...', 'warning');
                recheckJSZip();
            } else {
                updateStatus('æ­£åœ¨å¼ºåˆ¶åˆå§‹åŒ–RecipeProducer...', 'warning');
                try {
                    window.recipeProducer = new RecipeProducer();
                    updateStatus('âœ… RecipeProducerå¼ºåˆ¶åˆå§‹åŒ–æˆåŠŸ', 'success');
                } catch (error) {
                    updateStatus(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }
        
        function addTestRecipe() {
            const testTitle = document.getElementById('test-title').value.trim();
            if (!testTitle) {
                updateStatus('âŒ è¯·è¾“å…¥æµ‹è¯•æ ‡é¢˜', 'error');
                return;
            }
            
            const titleInput = document.getElementById('title');
            if (titleInput) {
                titleInput.value = testTitle;
                titleInput.dispatchEvent(new Event('input', { bubbles: true }));
                updateStatus(`âœ… å·²è®¾ç½®æµ‹è¯•Recipeæ ‡é¢˜: ${testTitle}`, 'success');
            }
        }
        
        function testDownloadFunction() {
            updateStatus('å¼€å§‹æµ‹è¯•ä¸‹è½½åŠŸèƒ½...', 'warning');
            
            if (!window.recipeProducer) {
                updateStatus('âŒ RecipeProduceræœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„recipe
            const validRecipes = window.recipeProducer.recipes.filter(r => r.title);
            updateStatus(`å½“å‰æœ‰æ•ˆRecipeæ•°é‡: ${validRecipes.length}`);
            
            if (validRecipes.length === 0) {
                updateStatus('âŒ æ²¡æœ‰æœ‰æ•ˆçš„Recipeï¼Œè¯·å…ˆæ·»åŠ æµ‹è¯•Recipe', 'error');
                return;
            }
            
            try {
                window.recipeProducer.generateAllRecipes();
                updateStatus('âœ… ä¸‹è½½åŠŸèƒ½è°ƒç”¨æˆåŠŸ', 'success');
            } catch (error) {
                updateStatus(`âŒ ä¸‹è½½åŠŸèƒ½è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆæ—¶è‡ªåŠ¨è¯Šæ–­
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                runDiagnosis();
            }, 2000); // ç­‰å¾…2ç§’ç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
        });
        
        // ç›‘å¬RecipeProduceråˆå§‹åŒ–
        const checkRecipeProducer = setInterval(() => {
            if (window.recipeProducer) {
                clearInterval(checkRecipeProducer);
                updateStatus('âœ… RecipeProducerå·²åˆå§‹åŒ–', 'success');
                setTimeout(runDiagnosis, 500);
            }
        }, 500);
    </script>
</body>
</html>