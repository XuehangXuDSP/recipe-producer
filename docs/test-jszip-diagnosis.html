<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSZip Loading Diagnosis</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow: auto; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
    </style>
</head>
<body>
    <h1>JSZip åŠ è½½è¯Šæ–­å·¥å…·</h1>
    
    <div id="diagnosis-results"></div>
    
    <div>
        <button class="btn-primary" onclick="runDiagnosis()">é‡æ–°è¯Šæ–­</button>
        <button class="btn-warning" onclick="loadFromCDN()">ä»CDNåŠ è½½JSZip</button>
        <button class="btn-success" onclick="testJSZipFunction()">æµ‹è¯•JSZipåŠŸèƒ½</button>
    </div>
    
    <div>
        <h3>ç½‘ç»œçŠ¶æ€æ£€æŸ¥ï¼š</h3>
        <div id="network-status"></div>
    </div>
    
    <div>
        <h3>æ–‡ä»¶åŠ è½½æ—¥å¿—ï¼š</h3>
        <pre id="load-log"></pre>
    </div>
    
    <!-- æœ¬åœ°JSZipæ–‡ä»¶ -->
    <script id="local-jszip" src="libs/jszip.min.js"></script>
    
    <script>
        let loadLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            loadLog.push(logEntry);
            updateLoadLog();
            console.log(message);
        }
        
        function updateLoadLog() {
            document.getElementById('load-log').textContent = loadLog.join('\\n');
        }
        
        function showStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            document.getElementById('diagnosis-results').appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('diagnosis-results').innerHTML = '';
            loadLog = [];
            updateLoadLog();
        }
        
        async function checkNetworkConnectivity() {
            const statusDiv = document.getElementById('network-status');
            
            try {
                // æµ‹è¯•æœ¬åœ°æ–‡ä»¶è®¿é—®
                const localResponse = await fetch('libs/jszip.min.js', { method: 'HEAD' });
                if (localResponse.ok) {
                    statusDiv.innerHTML += '<div class="status success">âœ… æœ¬åœ°JSZipæ–‡ä»¶å¯è®¿é—®</div>';
                    log('æœ¬åœ°JSZipæ–‡ä»¶å¯è®¿é—®', 'success');
                } else {
                    statusDiv.innerHTML += `<div class="status error">âŒ æœ¬åœ°JSZipæ–‡ä»¶è®¿é—®å¤±è´¥: ${localResponse.status}</div>`;
                    log(`æœ¬åœ°JSZipæ–‡ä»¶è®¿é—®å¤±è´¥: ${localResponse.status}`, 'error');
                }
                
                // æµ‹è¯•CDNè¿æ¥
                const cdnResponse = await fetch('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js', { method: 'HEAD' });
                if (cdnResponse.ok) {
                    statusDiv.innerHTML += '<div class="status success">âœ… CDNè¿æ¥æ­£å¸¸</div>';
                    log('CDNè¿æ¥æ­£å¸¸', 'success');
                } else {
                    statusDiv.innerHTML += '<div class="status warning">âš ï¸ CDNè¿æ¥æœ‰é—®é¢˜</div>';
                    log('CDNè¿æ¥æœ‰é—®é¢˜', 'warning');
                }
            } catch (error) {
                statusDiv.innerHTML += `<div class="status error">âŒ ç½‘ç»œæ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
                log(`ç½‘ç»œæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function runDiagnosis() {
            clearResults();
            log('å¼€å§‹JSZipåŠ è½½è¯Šæ–­...');
            
            // 1. æ£€æŸ¥å…¨å±€JSZipå˜é‡
            if (typeof JSZip !== 'undefined') {
                showStatus('âœ… JSZipå…¨å±€å˜é‡å·²å®šä¹‰', 'success');
                log('JSZipå…¨å±€å˜é‡å·²å®šä¹‰');
                
                // æ£€æŸ¥JSZipç‰ˆæœ¬
                if (JSZip.version) {
                    showStatus(`âœ… JSZipç‰ˆæœ¬: ${JSZip.version}`, 'success');
                    log(`JSZipç‰ˆæœ¬: ${JSZip.version}`);
                }
                
                // æµ‹è¯•JSZipåŸºæœ¬åŠŸèƒ½
                try {
                    const testZip = new JSZip();
                    testZip.file('test.txt', 'Hello World');
                    showStatus('âœ… JSZipåŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡', 'success');
                    log('JSZipåŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡');
                } catch (error) {
                    showStatus(`âŒ JSZipåŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    log(`JSZipåŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                showStatus('âŒ JSZipå…¨å±€å˜é‡æœªå®šä¹‰', 'error');
                log('JSZipå…¨å±€å˜é‡æœªå®šä¹‰');
            }
            
            // 2. æ£€æŸ¥scriptæ ‡ç­¾
            const scriptTags = document.querySelectorAll('script[src*="jszip"]');
            if (scriptTags.length > 0) {
                showStatus(`âœ… æ‰¾åˆ°${scriptTags.length}ä¸ªJSZip scriptæ ‡ç­¾`, 'success');
                log(`æ‰¾åˆ°${scriptTags.length}ä¸ªJSZip scriptæ ‡ç­¾`);
                
                scriptTags.forEach((script, index) => {
                    const src = script.src;
                    log(`Script ${index + 1}: ${src}`);
                    
                    // æ£€æŸ¥è„šæœ¬åŠ è½½çŠ¶æ€
                    if (script.readyState) {
                        log(`Script ${index + 1} readyState: ${script.readyState}`);
                    }
                });
            } else {
                showStatus('âš ï¸ æœªæ‰¾åˆ°JSZip scriptæ ‡ç­¾', 'warning');
                log('æœªæ‰¾åˆ°JSZip scriptæ ‡ç­¾');
            }
            
            // 3. æ£€æŸ¥æ§åˆ¶å°é”™è¯¯
            showStatus('ğŸ“‹ è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JSZipç›¸å…³é”™è¯¯', 'info');
            
            // 4. æ£€æŸ¥ç½‘ç»œè¿æ¥
            checkNetworkConnectivity();
        }
        
        function loadFromCDN() {
            log('å°è¯•ä»CDNåŠ è½½JSZip...');
            
            // ç§»é™¤ç°æœ‰çš„JSZipè„šæœ¬
            const existingScripts = document.querySelectorAll('script[src*="jszip"]');
            existingScripts.forEach(script => {
                script.remove();
                log('ç§»é™¤ç°æœ‰JSZipè„šæœ¬');
            });
            
            // åŠ è½½CDNç‰ˆæœ¬
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script.onload = () => {
                showStatus('âœ… CDNç‰ˆæœ¬JSZipåŠ è½½æˆåŠŸ', 'success');
                log('CDNç‰ˆæœ¬JSZipåŠ è½½æˆåŠŸ');
                
                // é‡æ–°è¯Šæ–­
                setTimeout(runDiagnosis, 100);
            };
            script.onerror = (error) => {
                showStatus('âŒ CDNç‰ˆæœ¬JSZipåŠ è½½å¤±è´¥', 'error');
                log('CDNç‰ˆæœ¬JSZipåŠ è½½å¤±è´¥: ' + error);
            };
            
            document.head.appendChild(script);
            log('æ·»åŠ CDN JSZipè„šæœ¬æ ‡ç­¾');
        }
        
        function testJSZipFunction() {
            if (typeof JSZip === 'undefined') {
                showStatus('âŒ JSZipæœªåŠ è½½ï¼Œæ— æ³•æµ‹è¯•', 'error');
                return;
            }
            
            log('å¼€å§‹JSZipåŠŸèƒ½æµ‹è¯•...');
            
            try {
                const zip = new JSZip();
                zip.file('hello.txt', 'Hello World from JSZip Test!');
                zip.file('subfolder/test.txt', 'This is a test file in a subfolder');
                
                zip.generateAsync({type: 'blob'})
                    .then(function(content) {
                        showStatus('âœ… JSZip ZIPç”Ÿæˆæµ‹è¯•æˆåŠŸ', 'success');
                        log('JSZip ZIPç”Ÿæˆæµ‹è¯•æˆåŠŸ');
                        
                        // åˆ›å»ºä¸‹è½½é“¾æ¥
                        const url = URL.createObjectURL(content);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'jszip-test.zip';
                        a.textContent = 'ä¸‹è½½æµ‹è¯•ZIPæ–‡ä»¶';
                        a.style.display = 'block';
                        a.style.margin = '10px 0';
                        a.style.padding = '10px';
                        a.style.background = '#28a745';
                        a.style.color = 'white';
                        a.style.textDecoration = 'none';
                        a.style.borderRadius = '4px';
                        
                        document.body.appendChild(a);
                        showStatus('âœ… æµ‹è¯•ZIPæ–‡ä»¶ä¸‹è½½é“¾æ¥å·²åˆ›å»º', 'success');
                        log('æµ‹è¯•ZIPæ–‡ä»¶ä¸‹è½½é“¾æ¥å·²åˆ›å»º');
                    })
                    .catch(function(error) {
                        showStatus(`âŒ JSZip ZIPç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                        log(`JSZip ZIPç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                    });
            } catch (error) {
                showStatus(`âŒ JSZipæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                log(`JSZipæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯Šæ–­
        document.addEventListener('DOMContentLoaded', () => {
            log('è¯Šæ–­é¡µé¢åŠ è½½å®Œæˆ');
            setTimeout(runDiagnosis, 1000); // å»¶è¿Ÿ1ç§’ä»¥ç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
        });
        
        // ç›‘å¬è„šæœ¬åŠ è½½äº‹ä»¶
        document.getElementById('local-jszip').onload = () => {
            log('æœ¬åœ°JSZipè„šæœ¬onloadäº‹ä»¶è§¦å‘');
        };
        
        document.getElementById('local-jszip').onerror = (error) => {
            log('æœ¬åœ°JSZipè„šæœ¬onerroräº‹ä»¶è§¦å‘: ' + error);
        };
    </script>
</body>
</html>